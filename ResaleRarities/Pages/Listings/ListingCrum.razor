@page "/Listings/ListingCrum"
@page "/Listings/ListingCrum/{ListingId?}"
@using ApplicationCore.Models
@using ApplicationCore.Interfaces
@using ResaleRarities.Pages.Products
@using Infrastructure.Utility;
@using Microsoft.AspNetCore.Components.Authorization
@using ResaleRarities.Authentication
@using System.Security.Claims
@inject AuthenticationStateProvider authStateProvider

<div class="container mt-5">

    @if (!IsDataLoaded)
    {
        <!-- Show a spinner while data is loading -->
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p>Loading...</p>
        </div>
    }
    else
    {


        <!-- The listing has a edit form section for all of the products that can be added - can be multiple -->
        <EditForm Model="Listing" OnValidSubmit="HandleList">
            <DataAnnotationsValidator></DataAnnotationsValidator>
            <ValidationSummary></ValidationSummary>

            <div class="card register-card">
                <div class="card-header register-header-footer">
                    @(ListingId == null ? "Create" : "View") Listing -
                    @(Listing == null ? DateTime.Now.ToString("MM/dd/yyyy hh:mm tt") : Listing.DateTimePosted.ToString("MM/dd/yyyy hh:mm tt"))
                </div>
                <div class="card-body register-group">
                    <button type="button" class="btn btn-primary" @onclick="ShowProductModal" disabled="@(!IsDataLoaded)">Add Product</button>
                    <!-- Render list of added products -->
                    <div class="row">
                        @foreach (var product in Products)
                        {
                            @if (product != null)
                            {
                                <div class="col-md-4 col-12">
                                    <div class="listing-card">
                                        @{
                                            var frontImage = _unitofWork.Image.Get(image => image.ProductId == product.Id);
                                            if (frontImage != null)
                                            {
                                                <div class="justify-content-center d-flex">
                                                    <img src="@($"data:image;base64,{Convert.ToBase64String(frontImage.ImageData)}")" alt="Product Picture" class="listing-card-image" />
                                                </div>

                                            }
                                            else
                                            {
                                                <img src="https://via.placeholder.com/150" alt="Placeholder Image" class="listing-card-image" />
                                            }
                                        }
                                        <div class="listing-card-title text-center">@product.Name</div>
                                        <div class="listing-card-details">
                                            <p>Description: @product.Description</p>
                                            <p>Condition: @(product.Condition?.Type ?? "Not Listed")</p>
                                            <p>Category: @(product.Category?.Name ?? "Not Listed")</p>
                                        </div>

                                    </div>
                                </div>
                            }


                        }
                    </div>

                </div>

                <div class="d-flex justify-content-center">
                    <ProductModal ListingId="@Listing.Id" IsVisible="@IsProductModalVisible" IsVisibleChanged="UpdateVisibility" OnProductAdded="HandleProductAdded" />

                </div>


                <div class="card-footer register-footer">
                    <button type="submit" class="btn btn-primary">Save Listing</button>
                </div>
            </div>
        </EditForm>

    }
</div>

@code {
    [Parameter]
    public string? ListingId { get; set; }

    private Listing Listing { get; set; } = new Listing();
    private IEnumerable<Product> Products { get; set; } = new List<Product>();

    private string ProductName { get; set; } = string.Empty;
    private string ProductDescription { get; set; } = string.Empty;
    private bool IsProductModalVisible { get; set; } = false;

    [Inject]
    private IUnitofWork? _unitofWork { get; set; }
    [Inject]
    private NavigationManager Navigation { get; set; } // Inject NavigationManager
    private bool IsDataLoaded { get; set; } = false; // Flag to track data loading


    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }


    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        var customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
        var authState = await customAuthStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.FindFirst(ClaimTypes.Email).Value;
        var user = _unitofWork.ApplicationUser.Get(u => u.Email == userName);

        if (!string.IsNullOrEmpty(ListingId) && _unitofWork != null)
        {
            Listing = _unitofWork.Listing.Get(listing => listing.Id == ListingId);
        }
        else if (_unitofWork != null && user != null)
        {
            var draftLS = _unitofWork.ListingStatus.Get(ls => ls.StatusDescription == SD.LSDraft);
            var newListing = new Listing
                {
                    ListingStatusId = draftLS.Id,
                    ApplicationUserId = user.Id
                };
            _unitofWork.Listing.Add(newListing);
            _unitofWork.Commit();
            Listing = newListing;
        }
        else
        {
            //TODO: throw error
        }
        Products = _unitofWork!.Product.List(product => product.ListingId == Listing.Id);

        IsDataLoaded = true; // Set the flag to true after data is loaded
        StateHasChanged(); // Trigger re-rendering of the component
    }



    private void HandleList()
    {
        // Handle form submission
        _unitofWork.Listing.Update(Listing);
        _unitofWork.Commit();
    }

    // Method to show the product modal
    private void ShowProductModal()
    {
        // Set IsVisible to true to show the modal
        IsProductModalVisible = true;
    }
    private void UpdateVisibility(bool isVisible)
    {
        IsProductModalVisible = isVisible;
    }
    private void HandleProductAdded()
    {
        Products = _unitofWork!.Product.List(product => product.ListingId == Listing.Id);
    }
}
